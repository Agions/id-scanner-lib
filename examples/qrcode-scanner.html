<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ID Scanner Lib - äºŒç»´ç æ‰«æç¤ºä¾‹</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-bottom: 20px; }
    .video-container {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 20px auto;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
    }
    video, canvas {
      width: 100%;
      display: block;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    .controls {
      display: flex;
      gap: 12px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: #007AFF; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .btn-danger { background: #FF3B30; color: white; }
    .btn-danger:hover { background: #d32f2f; }
    .btn-secondary { background: #8E8E93; color: white; }
    .btn-upload {
      background: #34C759;
      color: white;
    }
    input[type="file"] { display: none; }
    .status {
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0;
    }
    .status-success { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }
    .status-info { background: #d1ecf1; color: #0c5460; }
    .result {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      margin: 12px 0;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .history-item {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .history-item:last-child { border-bottom: none; }
    .scan-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background: #007AFF;
      animation: scan 2s linear infinite;
    }
    @keyframes scan {
      0% { top: 0; }
      50% { top: 100%; }
      100% { top: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“± ID Scanner Lib - äºŒç»´ç æ‰«æç¤ºä¾‹</h1>
    
    <div class="controls">
      <button class="btn-primary" id="startCameraBtn">æ‰“å¼€æ‘„åƒå¤´</button>
      <button class="btn-danger" id="stopCameraBtn">å…³é—­æ‘„åƒå¤´</button>
      <label class="btn-upload">
        <input type="file" id="imageInput" accept="image/*">
        ä¸Šä¼ å›¾ç‰‡è¯†åˆ«
      </label>
      <button class="btn-secondary" id="clearHistoryBtn">æ¸…ç©ºå†å²</button>
    </div>

    <div id="status" class="status status-info">ç‚¹å‡»"æ‰“å¼€æ‘„åƒå¤´"å¼€å§‹æ‰«æ</div>

    <div class="video-container">
      <video id="video" playsinline></video>
      <canvas id="canvas"></canvas>
      <div class="scan-line" id="scanLine"></div>
    </div>

    <h3>æ‰«æç»“æœ</h3>
    <div class="result" id="result">ç­‰å¾…æ‰«æ...</div>

    <h3>å†å²è®°å½•</h3>
    <div class="result" id="history">
      <div class="history-item">æš‚æ— è®°å½•</div>
    </div>
  </div>

  <script type="module">
    import { QRCodeScanner, BarcodeFormat } from '../dist/id-scanner-lib.esm.js';

    // çŠ¶æ€
    let scanner = null;
    let scanInterval = null;
    let history = [];
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const status = document.getElementById('status');
    const result = document.getElementById('result');
    const historyEl = document.getElementById('history');
    const scanLine = document.getElementById('scanLine');

    // æ›´æ–°çŠ¶æ€
    function updateStatus(message, type = 'info') {
      status.textContent = message;
      status.className = `status status-${type}`;
    }

    // ç»˜åˆ¶æ‰«ææ¡†
    function drawBox(boundingBox) {
      if (!boundingBox) return;
      
      const { topLeft, topRight, bottomRight, bottomLeft } = boundingBox;
      
      ctx.strokeStyle = '#007AFF';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(topLeft.x, topLeft.y);
      ctx.lineTo(topRight.x, topRight.y);
      ctx.lineTo(bottomRight.x, bottomRight.y);
      ctx.lineTo(bottomLeft.x, bottomLeft.y);
      ctx.closePath();
      ctx.stroke();
    }

    // åˆå§‹åŒ–æ‰«æå™¨
    async function initScanner() {
      scanner = new QRCodeScanner({
        minConfidence: 0.7,
        returnImage: false,
        imageProcess: {
          preprocess: true,
          enhanceContrast: true,
          threshold: 128
        }
      });

      await scanner.initialize();
      updateStatus('æ‰«æå™¨å°±ç»ª', 'success');
    }

    // å¼€å§‹æ‘„åƒå¤´æ‰«æ
    async function startCamera() {
      try {
        await initScanner();

        // è·å–æ‘„åƒå¤´
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
        video.srcObject = stream;
        await video.play();

        // è®¾ç½® canvas å¤§å°
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // å¼€å§‹æ‰«æ
        scanInterval = setInterval(async () => {
          ctx.drawImage(video, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          
          const scanResult = await scanner.scan(imageData);
          
          if (scanResult) {
            // ç»˜åˆ¶è¾¹æ¡†
            drawBox(scanResult.boundingBox);
            
            // æ˜¾ç¤ºç»“æœ
            const resultData = {
              å†…å®¹: scanResult.data,
              æ ¼å¼: scanResult.format || scanResult.type,
              æ—¶é—´: new Date().toLocaleString()
            };
            
            result.textContent = JSON.stringify(resultData, null, 2);
            addToHistory(scanResult.data, scanResult.format);
            
            // æ’­æ”¾æç¤ºéŸ³
            playBeep();
          }
        }, 200);

        scanLine.style.display = 'block';
        updateStatus('æ­£åœ¨æ‰«æ...', 'success');
      } catch (error) {
        updateStatus(`é”™è¯¯: ${error.message}`, 'error');
      }
    }

    // åœæ­¢æ‰«æ
    function stopCamera() {
      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }
      
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      
      scanLine.style.display = 'none';
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      updateStatus('å·²åœæ­¢æ‰«æ', 'info');
    }

    // å›¾ç‰‡è¯†åˆ«
    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        updateStatus('æ­£åœ¨è¯†åˆ«...', 'info');

        if (!scanner) {
          await initScanner();
        }

        const img = new Image();
        img.onload = async () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const scanResult = await scanner.scan(imageData);

          if (scanResult) {
            result.textContent = JSON.stringify({
              å†…å®¹: scanResult.data,
              æ ¼å¼: scanResult.format || scanResult.type
            }, null, 2);
            addToHistory(scanResult.data, scanResult.format);
            updateStatus('è¯†åˆ«æˆåŠŸ!', 'success');
          } else {
            result.textContent = 'æœªæ£€æµ‹åˆ°äºŒç»´ç ';
            updateStatus('æœªæ£€æµ‹åˆ°äºŒç»´ç ', 'error');
          }
        };
        img.src = URL.createObjectURL(file);
      } catch (error) {
        updateStatus(`è¯†åˆ«å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æ·»åŠ åˆ°å†å²
    function addToHistory(data, format) {
      history.unshift({ data, format, time: new Date().toLocaleString() });
      if (history.length > 10) history.pop();
      
      historyEl.innerHTML = history.map(item => 
        `<div class="history-item">
          <strong>${item.format || 'QR Code'}</strong>: ${item.data}
          <br><small>${item.time}</small>
        </div>`
      ).join('');
    }

    // æ¸…ç©ºå†å²
    function clearHistory() {
      history = [];
      historyEl.innerHTML = '<div class="history-item">æš‚æ— è®°å½•</div>';
    }

    // æç¤ºéŸ³
    function playBeep() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 1000;
      oscillator.type = 'sine';
      gainNode.gain.value = 0.3;
      
      oscillator.start();
      oscillator.stop(audioContext.currentTime + 0.1);
    }

    // äº‹ä»¶ç»‘å®š
    document.getElementById('startCameraBtn').addEventListener('click', startCamera);
    document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
    document.getElementById('imageInput').addEventListener('change', handleImageUpload);
    document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
  </script>
</body>
</html>
