<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ID Scanner Lib - äººè„¸è¯†åˆ«ç¤ºä¾‹</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-bottom: 20px; }
    .video-container {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 20px auto;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
    }
    video {
      width: 100%;
      display: block;
    }
    .controls {
      display: flex;
      gap: 12px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #007AFF;
      color: white;
    }
    .btn-primary:hover { background: #0056b3; }
    .btn-danger {
      background: #FF3B30;
      color: white;
    }
    .btn-danger:hover { background: #d32f2f; }
    .btn-secondary {
      background: #8E8E93;
      color: white;
    }
    .status {
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0;
    }
    .status-success { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }
    .status-info { background: #d1ecf1; color: #0c5460; }
    .result {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      margin: 12px 0;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– ID Scanner Lib - äººè„¸è¯†åˆ«ç¤ºä¾‹</h1>
    
    <div class="controls">
      <button class="btn-primary" id="startBtn">å¼€å§‹æ£€æµ‹</button>
      <button class="btn-secondary" id="stopBtn">åœæ­¢æ£€æµ‹</button>
      <button class="btn-danger" id="disposeBtn">é‡Šæ”¾èµ„æº</button>
    </div>

    <div id="status" class="status status-info">ç‚¹å‡»"å¼€å§‹æ£€æµ‹"å¯åŠ¨æ‘„åƒå¤´</div>

    <div class="video-container">
      <video id="video" autoplay playsinline></video>
    </div>

    <div class="result" id="result">æ£€æµ‹ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>

    <div class="controls">
      <button class="btn-primary" id="compareBtn">äººè„¸æ¯”å¯¹</button>
      <button class="btn-secondary" id="livenessBtn">æ´»ä½“æ£€æµ‹</button>
    </div>
  </div>

  <script type="module">
    import { IDScanner, FaceModule, LoadingStateManager, LoadingState } from '../dist/id-scanner-lib.esm.js';

    // çŠ¶æ€ç®¡ç†
    const loadingManager = new LoadingStateManager();
    let faceModule = null;
    let isRunning = false;

    // UI å…ƒç´ 
    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const result = document.getElementById('result');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const disposeBtn = document.getElementById('disposeBtn');
    const compareBtn = document.getElementById('compareBtn');
    const livenessBtn = document.getElementById('livenessBtn');

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(message, type = 'info') {
      status.textContent = message;
      status.className = `status status-${type}`;
    }

    // ç›‘å¬åŠ è½½çŠ¶æ€
    loadingManager.on('progress', (progress) => {
      console.log('åŠ è½½è¿›åº¦:', progress);
      updateStatus(`æ¨¡å‹åŠ è½½ä¸­: ${progress.progress}%`, 'info');
    });

    loadingManager.on('stateChange', (state) => {
      if (state.state === LoadingState.READY) {
        updateStatus('æ¨¡å‹åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ£€æµ‹', 'success');
      } else if (state.state === LoadingState.ERROR) {
        updateStatus(`åŠ è½½å¤±è´¥: ${state.error}`, 'error');
      }
    });

    // åˆå§‹åŒ–
    async function init() {
      try {
        updateStatus('åˆå§‹åŒ–ä¸­...', 'info');
        
        // åˆ›å»ºäººè„¸æ¨¡å—
        faceModule = new FaceModule({
          // æ‡’åŠ è½½é…ç½® - åªåŠ è½½å¿…è¦çš„æ¨¡å‹
          extractEmbeddings: false,
          detectExpressions: false,
          detectAgeGender: false,
          
          // å›è°ƒ
          onFaceDetected: (faces) => {
            if (faces && faces.length > 0) {
              result.textContent = JSON.stringify({
                æ£€æµ‹åˆ°äººè„¸æ•°: faces.length,
                ç¬¬ä¸€ä¸ªäººè„¸: faces[0].box,
                æ—¶é—´: new Date().toISOString()
              }, null, 2);
            }
          },
          onError: (error) => {
            updateStatus(`é”™è¯¯: ${error.message}`, 'error');
          }
        });

        // å¼€å§‹åŠ è½½æ¨¡å‹
        loadingManager.startLoading(1);
        await faceModule.initialize();
        loadingManager.complete();

        updateStatus('åˆå§‹åŒ–å®Œæˆï¼Œç‚¹å‡»"å¼€å§‹æ£€æµ‹"', 'success');
      } catch (error) {
        updateStatus(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // å¼€å§‹æ£€æµ‹
    async function startDetection() {
      if (!faceModule) {
        updateStatus('è¯·å…ˆåˆå§‹åŒ–', 'error');
        return;
      }

      try {
        await faceModule.startFaceRecognition(video);
        isRunning = true;
        updateStatus('æ­£åœ¨æ£€æµ‹ä¸­...', 'success');
      } catch (error) {
        updateStatus(`å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // åœæ­¢æ£€æµ‹
    async function stopDetection() {
      if (faceModule && isRunning) {
        await faceModule.stopFaceRecognition();
        isRunning = false;
        updateStatus('å·²åœæ­¢æ£€æµ‹', 'info');
      }
    }

    // é‡Šæ”¾èµ„æº
    async function dispose() {
      await stopDetection();
      
      if (faceModule) {
        await faceModule.dispose();
        faceModule = null;
      }
      
      loadingManager.dispose();
      updateStatus('èµ„æºå·²é‡Šæ”¾', 'info');
    }

    // äº‹ä»¶ç»‘å®š
    startBtn.addEventListener('click', startDetection);
    stopBtn.addEventListener('click', stopDetection);
    disposeBtn.addEventListener('click', dispose);

    // äººè„¸æ¯”å¯¹ç¤ºä¾‹
    compareBtn.addEventListener('click', async () => {
      result.textContent = 'è¯·åœ¨æ‘„åƒå¤´å‰æ”¾ç½®ä¸¤å¼ äººè„¸ç…§ç‰‡è¿›è¡Œæ¯”å¯¹...';
    });

    // æ´»ä½“æ£€æµ‹ç¤ºä¾‹
    livenessBtn.addEventListener('click', async () => {
      result.textContent = 'æ­£åœ¨è¿›è¡Œæ´»ä½“æ£€æµ‹...';
      // æ´»ä½“æ£€æµ‹é€»è¾‘
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    init();
  </script>
</body>
</html>
